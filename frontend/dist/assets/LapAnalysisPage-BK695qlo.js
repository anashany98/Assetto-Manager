import{r as u,j as r,T as R,a as E,A as L,n as I,L as z}from"./index-MjGtIaAt.js";import{C as P}from"./circle-check-big-D_wv1sd6.js";import{T as U}from"./triangle-alert-ko4KflD0.js";import{Z as D}from"./zap-BctN5ITw.js";import{I as G}from"./info-BJzi6qvF.js";import{A as K}from"./arrow-left-PwRceB5D.js";const C={GT3:{reaction:{good:.2,bad:.5},brake_sigma:{good:.05,bad:.15},throttle_jerk:{good:5,bad:15},microcorrections:{good:2,bad:8}},MONOPLAZA:{reaction:{good:.1,bad:.3},brake_sigma:{good:.08,bad:.2},throttle_jerk:{good:10,bad:30},microcorrections:{good:5,bad:15}},TURISMO:{reaction:{good:.3,bad:.6},brake_sigma:{good:.04,bad:.12},throttle_jerk:{good:3,bad:10},microcorrections:{good:1,bad:5}},DRIFT:{reaction:{good:.5,bad:1},brake_sigma:{good:.1,bad:.3},throttle_jerk:{good:50,bad:100},microcorrections:{good:10,bad:30}},CLASICO:{reaction:{good:.4,bad:.8},brake_sigma:{good:.1,bad:.25},throttle_jerk:{good:2,bad:8},microcorrections:{good:5,bad:15}},UNKNOWN:{reaction:{good:.3,bad:.6},brake_sigma:{good:.05,bad:.15},throttle_jerk:{good:5,bad:15},microcorrections:{good:2,bad:8}}},v=t=>t.length===0?0:t.reduce((e,s)=>e+s,0)/t.length,W=t=>{if(t.length===0)return 0;const e=v(t),s=t.reduce((o,a)=>o+Math.pow(a-e,2),0)/t.length;return Math.sqrt(s)},A=(t,e,s)=>Math.min(Math.max(t,e),s),f=(t,e,s)=>e<s?t<=e?1:t>=s?0:1-(t-e)/(s-e):t>=e?1:t<=s?0:1-(e-t)/(e-s);function B(t){let e=0,s=0,o=0,a=0,n=0;for(const c of t)c.rpm>e&&(e=c.rpm),Math.abs(c.steer)>s&&(s=Math.abs(c.steer)),c.speed>o&&(o=c.speed),c.brake>.01&&a++,c.brake>.8&&n++;const d=a>0?n/a:0,i={MONOPLAZA:0,GT3:0,TURISMO:0,DRIFT:0,CLASICO:0,UNKNOWN:0};e>8500?i.MONOPLAZA+=.8:e>=7e3&&e<=8500?i.GT3+=.6:e<6500&&(i.CLASICO+=.5),s>400?i.DRIFT+=1:s<120&&(i.MONOPLAZA+=.2),d>.3?(i.MONOPLAZA+=.3,i.GT3+=.2):i.CLASICO+=.3;let m="UNKNOWN",l=0;Object.keys(i).forEach(c=>{c!=="UNKNOWN"&&i[c]>l&&(l=i[c],m=c)});const h=A(l,0,1);return h<.4?{carClass:"UNKNOWN",confidence:0}:{carClass:m,confidence:h}}function F(t){const e=[];let s="GAS",o=0;for(let a=1;a<t.length;a++){const n=t[a],d=t[a-1];if(s==="GAS"&&d.throttle>.1&&n.throttle<=.05&&(s="COAST",o=n.timestamp),s==="COAST"&&n.brake>.05){const i=n.timestamp-o;i<2&&e.push(i),s="BRAKE"}n.throttle>.1&&(s="GAS")}return v(e)||0}function Z(t){const e=[];for(const s of t)s.brake>.1&&e.push(s.brake);return e.length<20?0:W(e)}function J(t){let e=0;for(let o=1;o<t.length;o++){const a=Math.abs(t[o].steer-t[o-1].steer);a>=1&&a<=5&&e++}const s=t[t.length-1].timestamp-t[0].timestamp;return s>0?e/s:0}function $(t,e){const s=Math.floor(1/e),o=[];let a=0;for(let n=1;n<t.length;n++){const d=Math.abs(t[n].throttle-t[n-1].throttle)/e;d>a&&(a=d),n%s===0&&(o.push(a),a=0)}return v(o)||0}function V(t,e){let s=0,o=0,a=0;for(const n of t)n.rpm>e*.98&&s++,n.rpm<e*.45&&n.throttle>.6?a+=.05:(a>.5&&o++,a=0);return{overRev:s,lugging:o}}function q(t){if(!t||t.length<100)return{carClass:"UNKNOWN",confidence:0,score:0,style:"No Data",highlights:[],warnings:["Datos insuficientes"],tips:[],metrics:{reactionTime:0,brakeConsistency:0,microCorrections:0,throttleJerk:0,luggingEvents:0,overRevEvents:0}};const e=(t[t.length-1].timestamp-t[0].timestamp)/t.length,{carClass:s,confidence:o}=B(t),a=C[s]||C.UNKNOWN,n=Math.max(...t.map(M=>M.rpm)),d=F(t),i=Z(t),m=J(t),l=$(t,e),{overRev:h,lugging:c}=V(t,n),g=f(d,a.reaction.good,a.reaction.bad),p=f(i,a.brake_sigma.good,a.brake_sigma.bad),x=f(m,a.microcorrections.good,a.microcorrections.bad),w=A(1-(h+c)*.05,0,1),S=f(l,a.throttle_jerk.good,a.throttle_jerk.bad),T=p,O=(.2*g+.2*p+.15*x+.15*T+.15*S+.15*w)*100,_=Math.round(O),N=[],j=[],y=[];g>.8?N.push("Reflejos excelentes en frenada"):g<.4&&j.push("Tardas mucho en pisar el freno tras soltar gas (Coasting)"),x>.8?N.push("Manos muy suaves y precisas"):x<.4&&y.push("Intentas corregir demasiado el volante, busca movimientos más suaves"),c>2&&j.push("Uso de marchas largas con bajas RPM (Lugging) detectado"),l>a.throttle_jerk.bad&&y.push("Sé más progresivo con el acelerador para evitar desestabilizar el coche");let k="Equilibrado";return x<.3&&l>10&&(k="Agresivo"),g>.8&&p>.8&&(k="Preciso"),{carClass:s,confidence:o,score:_,style:k,highlights:N,warnings:j,tips:y,metrics:{reactionTime:d,brakeConsistency:i,microCorrections:m,throttleJerk:l,luggingEvents:c,overRevEvents:h}}}function H({lapId:t}){const[e,s]=u.useState(null),[o,a]=u.useState(!0),[n,d]=u.useState(null);if(u.useEffect(()=>{t&&(async()=>{try{a(!0);const h=(await E.get(`${L}/telemetry/lap/${t}/telemetry`)).data.map(g=>({timestamp:g.t/1e3,speed:g.s/3.6,rpm:g.r,gear:g.g,steer:g.str||0,throttle:g.gas||0,brake:g.brk||0,spline:g.n}));if(h.length===0)throw new Error("No hay datos de telemetría disponibles para esta vuelta");const c=q(h);s(c)}catch(l){console.error(l),d("No se pudo analizar la sesión.")}finally{a(!1)}})()},[t]),o)return r.jsx("div",{className:"p-8 text-center animate-pulse",children:"Analizando conducción..."});if(n)return r.jsx("div",{className:"p-8 text-center text-red-400",children:n});if(!e)return null;const i=e.score>=80?"text-green-400 border-green-500":e.score>=60?"text-yellow-400 border-yellow-500":"text-red-400 border-red-500";return r.jsxs("div",{className:"bg-gray-900 rounded-3xl overflow-hidden shadow-2xl max-w-md mx-auto border border-gray-800",children:[r.jsxs("div",{className:"relative p-8 text-center bg-gradient-to-b from-gray-800 to-gray-900",children:[r.jsx("div",{className:`w-32 h-32 mx-auto rounded-full border-8 flex items-center justify-center mb-4 shadow-[0_0_30px_rgba(0,0,0,0.5)] ${i}`,children:r.jsxs("div",{children:[r.jsx("span",{className:"text-5xl font-black block",children:e.score}),r.jsx("span",{className:"text-xs font-bold uppercase tracking-wider opacity-70",children:"Puntos"})]})}),r.jsx("h2",{className:"text-2xl font-bold text-white mb-1",children:"Análisis de Pilotaje"}),r.jsxs("div",{className:"inline-block px-3 py-1 rounded-full bg-white/10 text-blue-300 text-sm font-bold border border-white/5",children:["Estilo: ",e.style]}),e.carClass!=="UNKNOWN"&&r.jsxs("p",{className:"mt-2 text-xs text-gray-500",children:["Detectado: ",e.carClass," (",Math.round(e.confidence*100),"% conf)"]})]}),r.jsxs("div",{className:"p-6 border-t border-gray-800",children:[r.jsxs("h3",{className:"text-green-400 font-bold flex items-center gap-2 mb-4 uppercase text-sm tracking-wider",children:[r.jsx(P,{size:18})," Puntos Fuertes"]}),e.highlights.length>0?r.jsx("ul",{className:"space-y-3",children:e.highlights.map((m,l)=>r.jsxs("li",{className:"flex gap-3 text-gray-300 text-sm bg-green-900/10 p-3 rounded-lg border border-green-500/10",children:[r.jsx(R,{size:16,className:"text-yellow-500 shrink-0 mt-0.5"}),m]},l))}):r.jsx("p",{className:"text-gray-500 text-sm italic",children:"Sigue practicando para destacar..."})]}),r.jsxs("div",{className:"p-6 border-t border-gray-800 bg-red-500/5",children:[r.jsxs("h3",{className:"text-orange-400 font-bold flex items-center gap-2 mb-4 uppercase text-sm tracking-wider",children:[r.jsx(U,{size:18})," Áreas de mejora"]}),e.warnings.length>0||e.tips.length>0?r.jsxs("ul",{className:"space-y-3",children:[e.warnings.map((m,l)=>r.jsxs("li",{className:"flex gap-3 text-gray-300 text-sm bg-red-900/10 p-3 rounded-lg border border-red-500/10",children:[r.jsx(D,{size:16,className:"text-red-400 shrink-0 mt-0.5"}),m]},l)),e.tips.map((m,l)=>r.jsxs("li",{className:"flex gap-3 text-gray-400 text-sm bg-blue-900/10 p-3 rounded-lg border border-blue-500/10",children:[r.jsx(G,{size:16,className:"text-blue-400 shrink-0 mt-0.5"}),m]},`tip-${l}`))]}):r.jsx("p",{className:"text-gray-500 text-sm italic",children:"¡Vaya! Una vuelta muy limpia."})]}),r.jsxs("div",{className:"p-6 border-t border-gray-800 grid grid-cols-2 gap-4",children:[r.jsx(b,{label:"Reflejos",val:e.metrics.reactionTime,goodLimit:.4,unit:"s",inverse:!0}),r.jsx(b,{label:"Frenada",val:e.metrics.brakeConsistency,goodLimit:.1,unit:"σ",inverse:!0}),r.jsx(b,{label:"Volante",val:e.metrics.microCorrections,goodLimit:5,unit:"/s",inverse:!0}),r.jsx(b,{label:"Suavidad",val:e.metrics.throttleJerk,goodLimit:10,unit:"jk",inverse:!0})]})]})}function b({label:t,val:e,goodLimit:s,inverse:o}){const n=(o?e<=s:e>=s)?"text-green-400":"text-orange-400";let d="Normal";return o&&(e<=s*.8?d="Excelente":e>s*1.5&&(d="Mejorable")),r.jsxs("div",{className:"bg-gray-800 p-3 rounded-lg text-center",children:[r.jsx("p",{className:"text-xs text-gray-500 uppercase font-bold",children:t}),r.jsx("p",{className:`text-lg font-bold ${n}`,children:d})]})}function se(){const{id:t}=I();return t?r.jsx("div",{className:"min-h-screen bg-black text-white p-4",children:r.jsxs("div",{className:"max-w-md mx-auto",children:[r.jsxs(z,{to:"/",className:"inline-flex items-center gap-2 text-gray-400 hover:text-white mb-6 transition-colors",children:[r.jsx(K,{size:20}),"Volver"]}),r.jsxs("div",{className:"mb-6",children:[r.jsx("h1",{className:"text-2xl font-black italic",children:"TELEMETRÍA"}),r.jsx("p",{className:"text-gray-500",children:"Informe de tu última sesión"})]}),r.jsx(H,{lapId:parseInt(t)}),r.jsx("div",{className:"mt-8 text-center",children:r.jsx("p",{className:"text-xs text-gray-600",children:"VRacing Telemetry System v1.0"})})]})}):r.jsx("div",{children:"ID de vuelta no encontrado"})}export{se as default};
